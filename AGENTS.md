# AGENTS.md

Instructions for AI coding agents working on the Life XP codebase.

## Project Overview

Life XP is an iOS 18.1+ SwiftUI app structured as a Swift Playgrounds package. It treats personal growth like a balanced RPG, letting users track progress across life dimensions (Love, Money, Mind, Adventure) through packs of checklist items and narrative arcs with quests.

## Tech Stack

- **Language:** Swift 5.9+ (uses `BareSlashRegexLiterals`)
- **UI Framework:** SwiftUI with iOS 18.1 APIs
- **State Management:** Swift Observation for reactive state updates
- **Persistence:** `UserDefaults` via `PersistenceManager` (no external database)
- **Dependencies:** None—the project is self-contained with no third-party packages
- **Platforms:** iOS 18.1+ (iPhone and iPad); includes Linux placeholder for CI builds

## iOS 18.1 Architecture/Performance/Theming Updates

- **Observation-first state:** AppModel now uses Swift Observation to reduce overhead and keep state propagation crisp.
- **Adaptive animation scheduling:** Timeline-based effects pause when off-screen or in reduce-motion, and run at 120fps for steadier motion.
- **Intentional dark surfaces:** Background gradients and ambient glows are tuned to avoid pure black while keeping contrast and depth.

## Repository Structure

```
Life XP.swiftpm/
├── Package.swift          # Swift Package manifest (auto-generated by Playgrounds)
├── MyApp.swift            # App entry point, creates and injects AppModel
├── AppModel.swift         # Single source of truth for all app state
├── Models/                # Data structures (Arc, Quest, ChecklistItem, Badge, etc.)
├── Data/                  # Sample content factories (PackLibrary, ArcLibrary, SampleContent)
├── Utils/                 # Helpers (BrandTheme, Color+Hex, Haptics, PersistenceManager)
├── LinuxSupport/          # Placeholder target for non-Apple CI builds
├── Tests/                 # Unit tests (AppModuleTests)
└── [Feature Views]        # SwiftUI views (ContentView, HomeView, PacksView, etc.)
```

## Key Architecture Patterns

### AppModel as Single Source of Truth

All mutable state lives in `AppModel.swift`. This includes:
- Packs and arcs (static content loaded at init)
- Completion state (`completedItemIDs: Set<String>`)
- User settings (`UserSettings` struct)
- Streak tracking (current/best streak, last active day)
- Arc progress (start dates, XP calculations)

When modifying state, always go through `AppModel` methods—never mutate state directly in views.

### Persistence

- State is serialized to `UserDefaults` as a `PersistenceSnapshot`
- Writes are debounced (350ms) to avoid excessive disk I/O
- The snapshot includes a version number for future migrations
- Always sanitize loaded data to handle corrupt or outdated payloads

### Visibility and Safe Mode

- Some content is marked as "heavy" in `SampleContent.heavyItemIDs`
- When `hideHeavyTopics` is true, filter these items out using `items(for:)` or `allVisibleItems`
- Dimension filtering also applies—only show content for enabled dimensions

### XP and Leveling

- XP comes from completing checklist items and quests
- Level = `totalXP / 120 + 1` (always at least 1)
- Badges are computed dynamically in `unlockedBadges` based on XP thresholds, streaks, and arc completions

## Coding Conventions

### Swift Style

- Use Swift's native types and APIs; avoid force unwrapping unless absolutely safe
- Prefer `guard` for early returns and validation
- Use meaningful names that reflect domain concepts (e.g., `Quest`, `Arc`, `LifeDimension`)
- Mark `@MainActor` on types that interact with UI state

### SwiftUI Views

- Keep views focused—extract reusable components
- Use `BrandTheme` colors and `DesignSystem` constants for consistent styling
- Apply the `.brandCard()` modifier for card-style UI elements
- Prefer SF Symbols for icons (referenced via `systemImage` properties)

### Enums

- Make enums `CaseIterable`, `Codable`, and `Identifiable` when appropriate
- Provide computed properties for labels, icons, and other derived values
- Use raw values (`String`) for persistence compatibility

### Documentation

- Add doc comments (`///`) for public types and non-trivial methods
- Use `MARK: -` comments to organize sections within files

## Testing

### Running Tests

The project includes a minimal test target at `Tests/AppModuleTests/`.

**On macOS (Xcode or CLI with Swift toolchain):**
```bash
cd "Life XP.swiftpm"
swift test
```

**On Linux CI:**
The package conditionally compiles a placeholder target that doesn't depend on SwiftUI. Tests verify the placeholder builds correctly.

### Writing Tests

- Import the module with `@testable import AppModule`
- Use `#if canImport(SwiftUI)` guards when testing platform-specific code
- For `AppModel` testing, inject a mock `PersistenceManaging` to avoid UserDefaults pollution

## Building and Running

### Xcode

1. Open `Life XP.swiftpm` as a Swift Package in Xcode
2. Select an iOS 18.1+ simulator or device
3. Build and run (⌘R)

### Swift Playgrounds

1. Open `Life XP.swiftpm` directly in Swift Playgrounds on iPad or macOS
2. Press Run to launch the app in the Live View

### CI / Linux

The package compiles on Linux using the `LinuxSupport/Placeholder.swift` target. This keeps SwiftPM happy without requiring SwiftUI:
```bash
swift build
swift test
```

## Common Tasks

### Adding a New Checklist Item

1. Add the item to the appropriate pack in `Data/PackLibrary.swift`
2. Assign an `id`, `title`, `xp`, `dimensions`, and optionally `isPremium`
3. If the item is sensitive, add its ID to `SampleContent.heavyItemIDs`

### Adding a New Arc

1. Define the arc with chapters and quests in `Data/ArcLibrary.swift`
2. Register it in `SampleContent.arcs`
3. Quests need unique IDs—the arc-quest relationship is built automatically

### Adding a New Badge

1. Add the badge logic to `AppModel.unlockedBadges` computed property
2. Check for appropriate thresholds (XP, streaks, arc completions)
3. Return a `Badge` with a unique ID, name, description, and SF Symbol

### Modifying Settings

1. Add the new setting to `UserSettings` struct in `AppModel.swift`
2. Provide a default value in the memberwise initializer
3. Handle missing keys in `init(from decoder:)` using `decodeIfPresent`
4. Add accessor properties on `AppModel` if needed for backward compatibility

## Important Considerations

### No StoreKit Yet

Premium gating is a simple boolean (`premiumUnlocked`). There's no actual IAP integration—this is placeholder logic.

### No Networking

All content is generated in-code. There's no backend, API calls, or remote data fetching.

### Localization

UI strings are currently hardcoded in Dutch (e.g., coach messages, labels). If adding new strings, follow the existing pattern but be aware localization infrastructure isn't set up yet.

### Haptics

Use `HapticsEngine` methods (`lightImpact()`, `softCelebrate()`, `success()`) for feedback on user actions. These are no-ops on unsupported platforms.

## Agent Workflow Notes

- Keep changes localized; avoid formatting large unrelated sections when making small edits.
- If you add new files inside the Swift package, place package-specific guidance in `Life XP.swiftpm/AGENTS.md` to narrow the scope.
- Prefer `rg` for search; avoid recursive `ls -R` or `grep -R` in large directories.

## Files to Avoid Editing

- `Package.swift` — Auto-generated by Swift Playgrounds; manual edits may be overwritten
- `.swiftpm/` directory contents — Playgrounds workspace metadata

## Quick Reference

| Concept | Location |
|---------|----------|
| App state | `AppModel.swift` |
| Data models | `Models/` directory |
| Sample content | `Data/` directory |
| UI theming | `Utils/BrandTheme.swift` |
| Persistence | `Utils/PersistenceManager.swift` |
| Entry point | `MyApp.swift` |
